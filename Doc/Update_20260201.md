# 数据库架构更新与日志系统增强文档 (2026-02-01)

## 1. 变更背景
为了更好地支持系统日志分类（如：普通记录、报警记录），并确保数据库架构在系统升级过程中的完整性，对底层实体模型、自动生成逻辑及数据库自动修复机制进行了优化。

## 2. 核心修改内容

### 2.1 实体模型增强
- **DoorBitConfigEntity & PanelBitConfigEntity**:
    - 新增 `LogTypeId` 字段。作为模版配置，允许用户预定义该类点位触发后的日志类型（1=普通, 2=报警）。
- **DevicePointConfigEntity**:
    - 确保包含 `LogTypeId` 字段，用于存储每个具体点位的运行期配置。

### 2.2 自动生成逻辑优化 (DbPointGenerator)
- **LogTypeId 继承机制**:
    - 在批量生成“门点位”或“面板点位”时，自动从其对应的“点位模版”中获取 `LogTypeId` 并透传给生成的 `DevicePointConfigEntity`。
    - 确保生成的点位在记录日志时能自动归类到正确的类型中。

### 2.3 数据库自动修复机制 (DatabaseFixer & DevvarlistViewModel)
- **架构一致性检查**:
    - 在 `DatabaseFixer.FixSchema` 和 `DevvarlistViewModel.CheckSchema` 中新增了对 `LogTypeId` 字段的自动检测。
    - 如果数据库表中缺失该字段，程序会自动执行 `ALTER TABLE` 语句添加该列。
- **缺失字段补全**:
    - 扩展了 `DevvarlistViewModel.CheckSchema`，使其能自动补全更多关键字段，包括：
        - 日志相关：`IsLogEnabled` (启用日志), `LogTriggerState` (触发状态), `LogMessage` (日志消息)。
        - 同步相关：`IsSyncEnabled` (启用同步), `SyncTargetDeviceId` (目标设备), `SyncTargetAddress` (目标地址)。
- **脏数据修复**:
    - 自动将数据库中 `LogTypeId=0` 的旧数据修正为默认值 `1`，避免非法枚举导致逻辑判断失效。

## 3. 影响范围
- **数据库表**: `DevicePointConfig`, `DoorBitConfig`, `PanelBitConfig` 控制表。
- **功能模块**: 
    - 批量配置生成。
    - 自动采集日志入库。
    - 数据库启动自动维护。

## 4. 提交备注
本次提交包含以上所有架构调整及相关的代码优化，旨在提升系统的健壮性和数据维护的自动化水平。
