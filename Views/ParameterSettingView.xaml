<UserControl x:Class="DoorMonitorSystem.Views.ParameterSettingView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:DoorMonitorSystem.Views"
             xmlns:uc="clr-namespace:DoorMonitorSystem.UControl"
             xmlns:vm="clr-namespace:DoorMonitorSystem.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200">
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- [0] é¡¶éƒ¨æ“ä½œå·¥å…·æ  -->
        <Border Padding="10,0,10,10" BorderThickness="0,0,0,1" BorderBrush="#22FFFFFF" Margin="0,0,0,10">
            <Grid>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Path Data="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41l-0.36,2.54c-0.59,0.24-1.13,0.57-1.62,0.94L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.81,11.69,4.81,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" 
                          Fill="#00E5FF" Stretch="Uniform" Width="20" Height="20" Margin="0,0,10,0"/>
                    <TextBlock Text="ç«™å°å‚æ•°ç›‘æŽ§ä¸Žé…ç½®" Foreground="White" FontSize="18" FontWeight="Bold" Opacity="0.8"/>
                </StackPanel>
                
                <Button HorizontalAlignment="Right" Command="{Binding ToggleManagementCommand}" Visibility="{Binding AdminVisibility}" Style="{StaticResource ActionButton}" Padding="15,4">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="âš™ æ¨¡æ¿ç®¡ç†" VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <Border Width="8" Height="8" CornerRadius="4" Background="#FF3D00">
                             <Border.Style>
                                 <Style TargetType="Border">
                                     <Setter Property="Visibility" Value="Collapsed"/>
                                     <Style.Triggers>
                                         <DataTrigger Binding="{Binding IsManagementMode}" Value="True">
                                             <Setter Property="Visibility" Value="Visible"/>
                                         </DataTrigger>
                                     </Style.Triggers>
                                 </Style>
                             </Border.Style>
                        </Border>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- [1] ç«™å°å®žæ—¶æ˜¾ç¤ºåŒº -->
        <ItemsControl Grid.Row="1" ItemsSource="{Binding StationSettings}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate DataType="{x:Type vm:StationParameterViewModel}">
                    <!-- ç¼©å° Margin å’Œ Padding æå‡å¯†åº¦ -->
                    <Border Background="#1a1f2e" CornerRadius="12" Margin="5" Padding="15" Width="550">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/> <!-- æ ‡é¢˜åŒº -->
                                <RowDefinition Height="Auto"/> <!-- é€šè®¯é…ç½®åŒº -->
                                <RowDefinition Height="*"/>    <!-- å‚æ•°åž‚ç›´åˆ—è¡¨åŒº -->
                            </Grid.RowDefinitions>

                            <!-- [1] ç«™å°åç§°å¤´ -->
                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,15">
                                <Rectangle Width="4" Height="20" Fill="#00E5FF" Margin="0,0,10,0" RadiusX="2" RadiusY="2"/>
                                <TextBlock Text="{Binding StationName}" 
                                           Foreground="#00E5FF" 
                                           FontSize="18" 
                                           FontWeight="Black" 
                                           VerticalAlignment="Center"/>
                            </StackPanel>

                            <!-- [2] é¡¶éƒ¨é€šè®¯å¤´ï¼šåž‹å·ä¸Žé—¨å· (æ¨ªå‘ç´§å‡‘å¸ƒå±€) -->
                            <Border Grid.Row="1" Background="#0FFFFFFF" CornerRadius="8" Padding="10,8" Margin="0,0,0,15">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                        <!-- åž‹å·é€‰æ‹© -->
                                        <StackPanel Margin="0,0,12,0">
                                            <TextBlock Text="ç«™å°æ¨¡åž‹" Foreground="#888888" FontSize="11" Margin="0,0,0,4"/>
                                            <ComboBox Width="130" Height="30" VerticalContentAlignment="Center"
                                                      ItemsSource="{Binding AsdModels}"
                                                      SelectedItem="{Binding SelectedAsdModel}"
                                                      DisplayMemberPath="DisplayName"
                                                      FontSize="15" FontWeight="Bold"
                                                      Background="#151515" BorderBrush="#44FFFFFF"/>
                                        </StackPanel>
                                        
                                        <!-- ç‰©ç† ID -->
                                        <StackPanel>
                                            <TextBlock Text="é—¨å·(PHYS)" Foreground="#888888" FontSize="11" Margin="0,0,0,4"/>
                                            <TextBox Width="70" Height="30" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"
                                                     Text="{Binding DoorId}"
                                                     FontSize="16" FontWeight="Black"
                                                     Background="#050505" Foreground="White" 
                                                     BorderBrush="#00E5FF" />
                                        </StackPanel>
                                    </StackPanel>

                                    <!-- æ“ä½œæŒ‰é’®ç»„ -->
                                    <StackPanel Orientation="Horizontal">
                                        <Button Content="è¯»å–" Command="{Binding ReadCommand}"
                                                Width="85" Height="30" Background="#37474F" 
                                                Style="{StaticResource ActionButton}" FontWeight="Bold" FontSize="13" Margin="0,0,8,0"/>
                                        <Button Content="å†™å…¥" Command="{Binding SaveCommand}"
                                                Width="85" Height="30" Background="#0D47A1" 
                                                Style="{StaticResource ActionButton}" FontWeight="Bold" FontSize="13"/>
                                        <Button Content="æ¸…ç©º" Command="{Binding ResetCommand}"
                                                Width="55" Height="28" Background="#B71C1C" Opacity="0.5"
                                                Style="{StaticResource ActionButton}" FontWeight="Medium" FontSize="11" Margin="15,0,0,0"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <!-- [3] è¯¦ç»†å‚æ•°ç¼–è¾‘ï¼šåž‚ç›´å›žæ­£å¸ƒå±€ -->
                            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Height="auto">
                                <ItemsControl ItemsSource="{Binding ParameterList}" HorizontalAlignment="Stretch">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Vertical"  />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <uc:SettingItem Label="{Binding Label, StringFormat='{}{0} :'}" 
                                                            Value="{Binding Value, Mode=TwoWay}"
                                                            ReadbackValue="{Binding ReadbackValue}" 
                                                            Unit="{Binding Unit}" 
                                                            Hint="{Binding Hint}" 
                                                            ToolTip="{Binding DebugInfo}"
                                                            Margin="0,0,0,6"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

 
        <!-- [2] æ¨¡æ¿ç®¡ç†æµ®å±‚ (é…ç½®æ¨¡å¼) -->
        <!-- Removed outer Grid, Border now handles Grid.RowSpan and Margin -->
        <Grid Grid.RowSpan="2" Margin="-10">
            <Grid.Style>
                <Style TargetType="Grid">
                    <Setter Property="Visibility" Value="Collapsed"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsManagementMode}" Value="True">
                            <Setter Property="Visibility" Value="Visible"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Grid.Style>

            <!-- æ¨¡ç³Šé®ç½©å±‚ -->
            <Border Background="#B2000000"/>

            <!-- å¯¹è¯æ¡†ä¸»ä½“ï¼šé›†ä¸­æ˜¾ç¤ºï¼Œè§£å†³å¤§ç‰‡ç•™ç™½é—®é¢˜ -->
            <Border Background="#1a1f2e" 
                    BorderBrush="#33FFFFFF" 
                    BorderThickness="1.5" 
                    CornerRadius="20" 
                    MaxWidth="1200" 
                    MaxHeight="650" 
                    Padding="30"
                    HorizontalAlignment="Center" 
                    VerticalAlignment="Center">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="60" Color="Black" Opacity="0.8" ShadowDepth="0"/>
                </Border.Effect>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- æ ‡é¢˜ä¸Žé€€å‡º -->
                    <Grid Margin="0,0,0,25">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Orientation="Horizontal" Grid.Column="0">
                            <Border Width="6" Height="30" Background="#00E5FF" CornerRadius="3" Margin="0,0,15,0"/>
                            <TextBlock Text="ç«™å°å‚æ•°æ¨¡æ¿ç®¡ç†" Foreground="#00E5FF" FontSize="28" FontWeight="Black"/>
                            <TextBlock Text="CONFIG MODE" Foreground="#555" FontSize="14" VerticalAlignment="Bottom" Margin="15,0,0,6" FontWeight="Bold"/>
                        </StackPanel>
                        
                        <Button Grid.Column="1" Content="âœ• é€€å‡ºç®¡ç†" Command="{Binding ToggleManagementCommand}"
                                Style="{StaticResource ActionButton}" Background="#33FF3D00" BorderBrush="#FF3D00" Foreground="#FF3D00" Padding="15,6"/>
                    </Grid>

                    <!-- ç®¡ç†ä¸»ä½“ -->
                    <TabControl Grid.Row="1" Background="Transparent" BorderThickness="0">
                        <TabControl.Resources>
                            <Style TargetType="TabItem">
                                <Setter Property="Foreground" Value="#888"/>
                                <Setter Property="FontSize" Value="14"/>
                                <Setter Property="Padding" Value="20,10"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="TabItem">
                                            <Border Name="Border" BorderThickness="0,0,0,2" Margin="0,0,10,0">
                                                <ContentPresenter x:Name="ContentSite" ContentSource="Header" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter TargetName="Border" Property="BorderBrush" Value="#00E5FF"/>
                                                    <Setter Property="Foreground" Value="#00E5FF"/>
                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </TabControl.Resources>
                        
                        <!-- é€‰é¡¹ 1: å‚æ•°é¡¹æ¨¡æ¿ -->
                        <TabItem Header=" [1] å‚æ•°é¡¹å®šä¹‰ ">
                            <Grid Margin="0,20,0,0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <DataGrid ItemsSource="{Binding ManageParameterDefines}" AutoGenerateColumns="False" CanUserAddRows="False"
                                          Background="#0DFFFFFF" BorderThickness="0" RowBackground="Transparent" AlternatingRowBackground="#05FFFFFF">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="æ˜¾ç¤ºæ ‡ç­¾" Binding="{Binding Label}" Width="*"/>
                                        <DataGridTextColumn Header="é€»è¾‘é”®å" Binding="{Binding BindingKey}" Width="*"/>
                                        <DataGridTextColumn Header="å•ä½" Binding="{Binding Unit}" Width="80"/>
                                        <DataGridTextColumn Header="æç¤º" Binding="{Binding Hint}" Width="150"/>
                                        <DataGridTemplateColumn Header="æ•°æ®ç±»åž‹" Width="100">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding DataType}" VerticalAlignment="Center" Margin="5,0"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                            <DataGridTemplateColumn.CellEditingTemplate>
                                                <DataTemplate>
                                                    <ComboBox SelectedValue="{Binding DataType, UpdateSourceTrigger=PropertyChanged}" 
                                                              ItemsSource="{Binding DataContext.PointDataTypes, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellEditingTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTextColumn Header="æŽ’åº" Binding="{Binding SortOrder}" Width="60"/>
                                        <DataGridTemplateColumn Header="æ“ä½œ" Width="80">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <Button Content="åˆ é™¤" Command="{Binding DataContext.DeleteDefCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=DataGrid}}" 
                                                            CommandParameter="{Binding}"
                                                            Background="#44B71C1C" Foreground="#FF8A80" BorderThickness="0" Height="22" FontSize="11"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,20,0,0">
                                    <Button Content="+ æ–°å¢žå‚æ•°é¡¹" Command="{Binding AddDefCommand}" Style="{StaticResource ActionButton}" Background="#2200E5FF" BorderBrush="#00E5FF" Padding="15,6"/>
                                    <Button Content="ðŸ’¾ ä¿å­˜æ¨¡æ¿å˜æ›´" Command="{Binding SaveDefsCommand}" Style="{StaticResource ActionButton}" Background="#0D47A1" Margin="20,0,0,0" Padding="20,6"/>
                                </StackPanel>
                            </Grid>
                        </TabItem>

                        <!-- é€‰é¡¹ 2: ç«™å°æ¨¡åž‹é…ç½® -->
                        <TabItem Header=" [2] ç«™å°æ¨¡åž‹ (ä¸‹æ‹‰æ¡†) ">
                            <Grid Margin="0,20,0,0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <DataGrid ItemsSource="{Binding ManageAsdModels}" AutoGenerateColumns="False" CanUserAddRows="False"
                                          Background="#0DFFFFFF" BorderThickness="0" RowBackground="Transparent" AlternatingRowBackground="#05FFFFFF">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="æ˜¾ç¤ºåç§°" Binding="{Binding DisplayName}" Width="*"/>
                                        <DataGridTextColumn Header="ç‰©ç† ID" Binding="{Binding PlcId}" Width="100"/>
                                        <DataGridTemplateColumn Header="æ“ä½œ" Width="80">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <Button Content="åˆ é™¤" Command="{Binding DataContext.DeleteModelCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=DataGrid}}" 
                                                            CommandParameter="{Binding}"
                                                            Background="#44B71C1C" Foreground="#FF8A80" BorderThickness="0" Height="22" FontSize="11"
                                                            HorizontalAlignment="Center" Width="50"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,20,0,0">
                                    <Button Content="+ æ–°å¢žæ¨¡åž‹" Command="{Binding AddModelCommand}" Style="{StaticResource ActionButton}" Background="#2200E5FF" BorderBrush="#00E5FF" Padding="15,6"/>
                                    <Button Content="ðŸ’¾ ä¿å­˜æ¨¡åž‹é…ç½®" Command="{Binding SaveModelsCommand}" Style="{StaticResource ActionButton}" Background="#0D47A1" Margin="20,0,0,0" Padding="20,6"/>
                                </StackPanel>
                            </Grid>
                        </TabItem>
                    </TabControl>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>
