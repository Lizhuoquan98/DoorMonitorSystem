<UserControl x:Class="DoorMonitorSystem.Views.DevvarlistView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:DoorMonitorSystem.Views"
             xmlns:vm="clr-namespace:DoorMonitorSystem.ViewModels"
             xmlns:cvt="clr-namespace:DoorMonitorSystem.Assets.Converters"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1100">
    
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <cvt:DataTypeToVisibilityConverter x:Key="DataTypeToVis"/>
        <cvt:IntToBoolConverter x:Key="IntToBool"/>

        <Style x:Key="BatchToggleButtonStyle" TargetType="ToggleButton">
            <Setter Property="Height" Value="30"/>
            <Setter Property="Padding" Value="15,0"/>
            <Setter Property="Background" Value="#8A2BE2"/>
            <Setter Property="BorderBrush" Value="#9370DB"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="Border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#AA8A2BE2"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#668A2BE2"/>
                                <Setter TargetName="Border" Property="BorderBrush" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <UserControl.DataContext>
        <vm:DevvarlistViewModel/>
    </UserControl.DataContext>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 1. 顶部：设备选择 -->
        <Border Grid.Row="0" Margin="0,0,0,10" Padding="10" Background="#11FFFFFF" CornerRadius="5" BorderBrush="#33FFFFFF" BorderThickness="1">
            <DockPanel>
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                    <TextBlock Text="当前设备：" VerticalAlignment="Center" FontSize="14" FontWeight="Bold" Foreground="White" Margin="0,0,10,0"/>
                    <ComboBox Width="200" ItemsSource="{Binding Devices}" SelectedItem="{Binding SelectedDevice}" DisplayMemberPath="Name" Height="28"/>
                </StackPanel>
                
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" HorizontalAlignment="Right">
                    
                    <!-- 批量生成工具 -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,10,0">
                        <ToggleButton x:Name="BtnBatchGen" Content="批量生成" Style="{StaticResource BatchToggleButtonStyle}" 
                                      IsChecked="{Binding IsBatchPopupOpen, Mode=TwoWay}"
                                      Command="{Binding OpenBatchPopupCommand}"
                                      Background="#8A2BE2" BorderBrush="#9370DB"/>
                        <Popup IsOpen="{Binding IsBatchPopupOpen, Mode=TwoWay}" StaysOpen="False" PlacementTarget="{Binding ElementName=BtnBatchGen}" AllowsTransparency="True" PopupAnimation="Fade">
                            <Border Background="#252526" BorderBrush="#3f3f46" BorderThickness="1" CornerRadius="6" Padding="15">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.5"/>
                                </Border.Effect>
                                <StackPanel Width="220">
                                    <TextBlock Text="⚡ 批量生成向导" Foreground="White" FontWeight="Bold" FontSize="14" Margin="0,0,0,15"/>

                                    <Grid Margin="0,0,0,10">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="10"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="10"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="10"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="生成对象:" Foreground="#BBB" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                        <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal">
                                            <RadioButton Content="站台门" IsChecked="{Binding BatchTargetType, Converter={StaticResource IntToBool}, ConverterParameter=0}" GroupName="G1" Foreground="White" Margin="0,0,10,0"/>
                                            <RadioButton Content="监控面板" IsChecked="{Binding BatchTargetType, Converter={StaticResource IntToBool}, ConverterParameter=1}" GroupName="G1" Foreground="White"/>
                                        </StackPanel>

                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="选择站台:" Foreground="#BBB" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                        <ComboBox Grid.Row="2" Grid.Column="1" ItemsSource="{Binding Stations}" SelectedItem="{Binding BatchSelectedStation}" DisplayMemberPath="StationName" Height="26"/>


                                    </Grid>

                                    <TextBlock Text="提示：基于[DoorBitConfig]模板裂变生成" Foreground="#666" FontSize="10" TextWrapping="Wrap" Margin="0,0,0,10"/>
                                    
                                    <Grid Margin="0,10,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="10"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Button Grid.Column="0" Content="⚙️ 地址映射" Command="{Binding OpenAddressMgrCommand}" Height="32" 
                                                Background="#444" BorderThickness="0" Foreground="White" FontSize="11" Cursor="Hand"/>
                                        <Button Grid.Column="2" Content="🚀 立即执行" Command="{Binding BatchGenerateCommand}" Height="32" 
                                                Background="#8A2BE2" BorderThickness="0" Foreground="White" FontWeight="SemiBold" Cursor="Hand"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </Popup>
                        
                        <!-- 地址配置管理弹窗 (Popup Mode) -->
                        <Popup IsOpen="{Binding IsAddressMgrOpen, Mode=TwoWay}" StaysOpen="True" Placement="Center" PlacementTarget="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type Window}}}" VerticalOffset="0" HorizontalOffset="0" AllowsTransparency="True" PopupAnimation="Fade">
                            <Border Background="#252526" BorderBrush="#00E5FF" BorderThickness="1" CornerRadius="8" Padding="15" Width="500" Height="400">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="20" ShadowDepth="5" Opacity="0.7"/>
                                </Border.Effect>
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <!-- Header -->
                                    <DockPanel Grid.Row="0" Margin="0,0,0,10" Background="Transparent">
                                        <TextBlock Text="⚙️ 站台物理地址配置" Foreground="#00E5FF" FontWeight="Bold" FontSize="16" DockPanel.Dock="Left"/>
                                        <Button Content="❌" Command="{Binding CloseAddressMgrCommand}" Width="20" Height="20" DockPanel.Dock="Right" HorizontalAlignment="Right"
                                                Background="Transparent" BorderThickness="0" Foreground="Gray" ClickMode="Press"/>
                                    </DockPanel>
                                    
                                    <!-- Data Grid -->
                                    <DataGrid Grid.Row="1" ItemsSource="{Binding AddressItems}" AutoGenerateColumns="False" CanUserAddRows="False"
                                              Background="#1E1E1E" BorderBrush="#333" RowBackground="#1E1E1E" Foreground="#DDD"
                                              HeadersVisibility="Column" GridLinesVisibility="Horizontal" HorizontalGridLinesBrush="#333" RowHeaderWidth="0">
                                        <DataGrid.ColumnHeaderStyle>
                                            <Style TargetType="DataGridColumnHeader">
                                                <Setter Property="Background" Value="#333"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Setter Property="Padding" Value="5"/>
                                                <Setter Property="BorderThickness" Value="0,0,1,0"/>
                                                <Setter Property="BorderBrush" Value="#555"/>
                                            </Style>
                                        </DataGrid.ColumnHeaderStyle>
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="ID" Binding="{Binding SortOrder}" Width="40" IsReadOnly="True" Foreground="#888"/>
                                            <DataGridTextColumn Header="名称" Binding="{Binding Name}" Width="*" IsReadOnly="True" FontWeight="Bold"/>
                                            <DataGridTextColumn Header="起始偏移(Byte)" Binding="{Binding ByteStartAddr, UpdateSourceTrigger=PropertyChanged}" Width="100"/>
                                            <DataGridTextColumn Header="长度(Byte)" Binding="{Binding ByteLength, UpdateSourceTrigger=PropertyChanged}" Width="80"/>
                                        </DataGrid.Columns>
                                    </DataGrid>
                                    
                                    <!-- Footer -->
                                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
                                        <TextBlock Text="设置特定对象的起始偏移，为0则使用批量计算" Foreground="#666" FontSize="10" VerticalAlignment="Center" Margin="0,0,20,0"/>
                                        <Button Content="保存配置" Command="{Binding SaveAddressConfigCommand}" Width="100" Height="30"
                                                Background="#007ACC" Foreground="White" BorderThickness="0"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </Popup>
                    </StackPanel>
                        

                    <Button Content="导入点表" Style="{StaticResource ActionButton}" Command="{Binding ImportPointsCommand}" Background="#CD853F" BorderBrush="#D2691E" Margin="0,0,10,0"/>
                    <Button Content="刷新列表" Style="{StaticResource ActionButton}" Command="{Binding LoadDevicesCommand}" Margin="0,0,10,0"/>
                    <Button Content="修改点位" Style="{StaticResource ActionButton}" Command="{Binding StartEditCommand}" Background="#1E90FF" BorderBrush="#1C86EE" Margin="0,0,10,0"/>
                    <Button Content="删除点位" Style="{StaticResource ActionButton}" Command="{Binding DeletePointCommand}" Background="#AA3333" BorderBrush="#FF4444"/>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- 2. 中部：添加/编辑表单 (分组布局) -->
        <Border Grid.Row="1" Margin="0,0,0,10" Padding="10" Background="#11FFFFFF" CornerRadius="5" BorderBrush="#33FFFFFF" BorderThickness="1">
            <Grid>
           
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/> <!-- Title -->
                    <RowDefinition Height="Auto"/> <!-- Groups -->
                </Grid.RowDefinitions>

                <TextBlock Text="新增点位配置 (New Point Config)"  FontSize="14" FontWeight="Bold" Foreground="#DDD" Margin="0,0,0,10"/>

                <!-- 1行6列横向布局 - 内部也横向压扁 -->
                <Grid Grid.Row="1"  Margin="0,0,0,5" HorizontalAlignment="Left" VerticalAlignment="Center">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/> <!-- Source -->
                        <ColumnDefinition Width="Auto"/> <!-- Processing -->
                        <ColumnDefinition Width="Auto"/> <!-- Binding -->
                        <ColumnDefinition Width="Auto"/> <!-- Sync -->
                        <ColumnDefinition Width="Auto"/> <!-- Log -->
                        <ColumnDefinition Width="Auto"/> <!-- Button -->
                    </Grid.ColumnDefinitions>

                    <!-- Col 0: 基础信息 -->
                    <GroupBox Header="基础信息 (Source)" Grid.Column="0" Margin="0,0,5,0" Foreground="#AAA" BorderBrush="#44FFFFFF" VerticalAlignment="Stretch">
                        <StackPanel Orientation="Horizontal" Margin="5" VerticalAlignment="Center">
                            <StackPanel Margin="0,0,5,0" Width="80">
                                <TextBlock Text="地址" Foreground="#888" FontSize="10"/>
                                <TextBox Text="{Binding NewPoint.Address}" ToolTip="例如: 40001"/>
                            </StackPanel>
                            <StackPanel Margin="0,0,5,0" Width="30">
                                <TextBlock Text="位" Foreground="#888" FontSize="10"/>
                                <TextBox Text="{Binding NewPoint.BitIndex}"/>
                            </StackPanel>
                            <StackPanel Margin="0,0,5,0" Width="65">
                                <TextBlock Text="类型" Foreground="#888" FontSize="10"/>
                                <ComboBox Text="{Binding NewPoint.DataType}" IsEditable="True">
                                    <ComboBoxItem Content="Bool"/>
                                    <ComboBoxItem Content="Word"/>
                                    <ComboBoxItem Content="Int16"/>
                                    <ComboBoxItem Content="UInt16"/>
                                    <ComboBoxItem Content="Real"/>
                                    <ComboBoxItem Content="Float"/>
                                    <ComboBoxItem Content="DWord"/>
                                </ComboBox>
                            </StackPanel>
                            <StackPanel >
                                <TextBlock Text="备注" Width="200" Foreground="#888" FontSize="10"/>
                                <TextBox Text="{Binding NewPoint.Description}"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>

                    <!-- Col 1: 业务处理 -->
                    <GroupBox Header="业务处理 (Processing)" Grid.Column="1" Margin="0,0,5,0" Foreground="#AAA" BorderBrush="#44FFFFFF" VerticalAlignment="Stretch">
                        <StackPanel Orientation="Horizontal" Margin="5" VerticalAlignment="Center">
                            <!-- 模拟量配置 (Analog) -->
                            <StackPanel Orientation="Horizontal" Visibility="{Binding NewPoint.DataType, Converter={StaticResource DataTypeToVis}, ConverterParameter=Analog}">
                                <StackPanel Margin="0,0,5,0" Width="50">
                                    <TextBlock Text="高限" Foreground="#888" FontSize="10"/>
                                    <TextBox Text="{Binding NewPoint.HighLimit}"/>
                                </StackPanel>
                                <StackPanel Width="50">
                                    <TextBlock Text="低限" Foreground="#888" FontSize="10"/>
                                    <TextBox Text="{Binding NewPoint.LowLimit}"/>
                                </StackPanel>
                            </StackPanel>

                            <!-- 开关量配置 (Boolean) -->
                            <StackPanel Orientation="Horizontal" Visibility="{Binding NewPoint.DataType, Converter={StaticResource DataTypeToVis}, ConverterParameter=Bool}">
                                <StackPanel Margin="0,0,5,0" Width="50">
                                    <TextBlock Text="0显示" Foreground="#888" FontSize="10"/>
                                    <TextBox Text="{Binding NewPoint.State0Desc}"/>
                                </StackPanel>
                                <StackPanel Margin="0,0,5,0" Width="50">
                                    <TextBlock Text="1显示" Foreground="#888" FontSize="10"/>
                                    <TextBox Text="{Binding NewPoint.State1Desc}"/>
                                </StackPanel>
                                <StackPanel Width="50">
                                    <TextBlock Text="报警值" Foreground="#888" FontSize="10"/>
                                    <ComboBox SelectedValue="{Binding NewPoint.AlarmTargetValue}" SelectedValuePath="Tag">
                                        <ComboBoxItem Content="无" Tag="{x:Null}"/>
                                        <ComboBoxItem Content="0">
                                            <ComboBoxItem.Tag>
                                                <sys:Int32>0</sys:Int32>
                                            </ComboBoxItem.Tag>
                                        </ComboBoxItem>
                                        <ComboBoxItem Content="1">
                                            <ComboBoxItem.Tag>
                                                <sys:Int32>1</sys:Int32>
                                            </ComboBoxItem.Tag>
                                        </ComboBoxItem>
                                    </ComboBox>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>

                    <!-- Col 2: 关联目标 -->
                    <GroupBox Header="关联目标 (Binding)" Grid.Column="2" Margin="0,0,5,0" Foreground="#AAA" BorderBrush="#44FFFFFF" VerticalAlignment="Stretch">
                        <StackPanel Orientation="Horizontal" Margin="5" VerticalAlignment="Center">
                            <!-- 自动关联信息展示 (只读) -->
                            <StackPanel Margin="0,0,5,0" VerticalAlignment="Center">
                                <TextBlock Text="已关联逻辑键 (Auto-Bound)" Foreground="#666" FontSize="10"/>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding NewPoint.UiBinding, TargetNullValue='-'}" Foreground="#4CAF50" FontWeight="Bold" Margin="0,0,5,0"/>
                                    <TextBlock Text="[" Foreground="#888"/>
                                    <TextBlock Text="{Binding NewPoint.BindingRole}" Foreground="#2196F3"/>
                                    <TextBlock Text="]" Foreground="#888"/>
                                </StackPanel>
                            </StackPanel>

                            <ToggleButton x:Name="BtnSelectPoint" Content="选择对象" Width="60" Height="34" Margin="0,0,5,0" VerticalAlignment="Bottom"
                                          Background="#22FFFFFF" Foreground="White" BorderBrush="#44FFFFFF" Command="{Binding LoadTreeCommand}"/>
                            
                            <Popup IsOpen="{Binding IsPopupOpen}" StaysOpen="False" PlacementTarget="{Binding ElementName=BtnSelectPoint}">
                                <Border Background="#1e1e1e" BorderBrush="#555" BorderThickness="1" MaxHeight="400" Width="350" Padding="5">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <TreeView ItemsSource="{Binding SelectorTree}" Background="Transparent" BorderThickness="0">
                                            <TreeView.ItemTemplate>
                                                <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                                    <StackPanel Orientation="Horizontal">
                                                        <!-- Icon/Type Indicator could be added here -->
                                                        <TextBlock Text="{Binding Name}" Foreground="White" Margin="2" ToolTip="{Binding FullDescription}">
                                                            <TextBlock.InputBindings>
                                                                <MouseBinding Gesture="LeftDoubleClick" Command="{Binding DataContext.SelectNodeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding}"/>
                                                            </TextBlock.InputBindings>
                                                        </TextBlock>
                                                    </StackPanel>
                                                </HierarchicalDataTemplate> 
                                            </TreeView.ItemTemplate>
                                        <TreeView.ItemContainerStyle>
                                            <Style TargetType="TreeViewItem">
                                                <Setter Property="IsExpanded" Value="False"/>
                                                <Setter Property="Foreground" Value="White"/>
                                            </Style>
                                        </TreeView.ItemContainerStyle>
                                    </TreeView>
                                    </ScrollViewer>
                                </Border>
                            </Popup>

                            <Button Content="X" Width="40" Height="34" Style="{StaticResource ActionButton}" Background="#333" BorderBrush="#555" VerticalAlignment="Bottom"
                                    Command="{Binding ClearBindingCommand}" Margin="0,0,5,0" ToolTip="清除绑定"/>

                            <!-- 简化的绑定状态显示 -->
                            <Border Background="#11FFFFFF" CornerRadius="3" Padding="2" VerticalAlignment="Bottom" Height="34" MinWidth="80">
                                <Grid VerticalAlignment="Center" HorizontalAlignment="Center">
                                     <TextBlock Text="未绑定" Foreground="#666" FontStyle="Italic" FontSize="10"
                                                Visibility="{Binding NewPoint.TargetType, Converter={StaticResource DataTypeToVis}, ConverterParameter=Analog}"/> 

                                    <StackPanel Orientation="Horizontal">
                                        <StackPanel.Style>
                                            <Style TargetType="StackPanel">
                                                <Setter Property="Visibility" Value="Visible"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding NewPoint.TargetType}" Value="None">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </StackPanel.Style>
                                        
                                        <TextBlock Text="{Binding NewPoint.TargetType}" Foreground="#44FF44" FontWeight="Bold" FontSize="10" Margin="0,0,3,0"/>
                                        <TextBlock Text="{Binding NewPoint.TargetObjId}" Foreground="White" FontSize="10"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </StackPanel>
                    </GroupBox>

                    <!-- Col 3: 同步转发 -->
                    <GroupBox Header="同步转发 (Sync)" Grid.Column="3" Margin="0,0,5,0" Foreground="#AAA" BorderBrush="#44FFFFFF" VerticalAlignment="Stretch">
                        <StackPanel Orientation="Horizontal" Margin="5" VerticalAlignment="Center">
                             <CheckBox Content="开启" IsChecked="{Binding NewPoint.IsSyncEnabled}" Foreground="White" Margin="0,0,5,0" VerticalAlignment="Center"/>
                             
                             <StackPanel Orientation="Horizontal" IsEnabled="{Binding NewPoint.IsSyncEnabled}" VerticalAlignment="Center">
                                 <StackPanel Margin="0,0,5,0"  >
                                     <TextBlock Text="目标设备" Foreground="#888" FontSize="10"/>
                                     <ComboBox ItemsSource="{Binding Devices}" SelectedValue="{Binding NewPoint.SyncTargetDeviceId}"  Width="150"  SelectedValuePath="ID" DisplayMemberPath="Name"/>
                                 </StackPanel>
                                 
                                 <StackPanel Margin="0,0,5,0" >
                                     <TextBlock Text="地址.位" Foreground="#888" FontSize="10"/>
                                     <Grid>
                                         <Grid.ColumnDefinitions>
                                             <ColumnDefinition Width="*"/>
                                             <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                         </Grid.ColumnDefinitions>
                                         <TextBox Grid.Column="0" Width="50"  Text="{Binding NewPoint.SyncTargetAddress}"/>
                                         <TextBlock Grid.Column="1" Text="." Foreground="White" VerticalAlignment="Bottom" Margin="1,0"/>
                                        <TextBox Grid.Column="2" Width="30" Text="{Binding NewPoint.SyncTargetBitIndex}"/>
                                     </Grid>
                                 </StackPanel>
                                 
                                 <StackPanel  >
                                     <TextBlock Text="模式" Foreground="#888" FontSize="10"/>
                                     <ComboBox SelectedIndex="{Binding NewPoint.SyncMode}">
                                         <ComboBoxItem Content="直接"/>
                                         <ComboBoxItem Content="取反"/>
                                     </ComboBox>
                                 </StackPanel>
                             </StackPanel>
                        </StackPanel>
                    </GroupBox>

                    <!-- Col 4: 日志 -->
                    <GroupBox Header="日志 (Log)" Grid.Column="4" Margin="0,0,5,0" Foreground="#AAA" BorderBrush="#44FFFFFF" VerticalAlignment="Stretch">
                        <StackPanel Orientation="Horizontal" Margin="5" VerticalAlignment="Center">
                            <CheckBox Content="开启" IsChecked="{Binding NewPoint.IsLogEnabled}" Foreground="White" Margin="0,0,5,0" VerticalAlignment="Center"/>
                            
                            <StackPanel Orientation="Horizontal" IsEnabled="{Binding NewPoint.IsLogEnabled}" VerticalAlignment="Center">
                                <StackPanel Margin="0,0,5,0" Width="70">
                                    <TextBlock Text="类型" Foreground="#888" FontSize="10"/>
                                    <ComboBox SelectedValue="{Binding NewPoint.LogTypeId}" SelectedValuePath="Tag">
                                        <ComboBoxItem Content="一般">
                                            <ComboBoxItem.Tag>
                                                <sys:Int32>1</sys:Int32>
                                            </ComboBoxItem.Tag>
                                        </ComboBoxItem>
                                        <ComboBoxItem Content="报警">
                                            <ComboBoxItem.Tag>
                                                <sys:Int32>2</sys:Int32>
                                            </ComboBoxItem.Tag>
                                        </ComboBoxItem>
                                    </ComboBox>
                                </StackPanel>
                                
                                <StackPanel Width="80">
                                    <TextBlock Text="消息" Foreground="#888" FontSize="10"/>
                                    <TextBox Text="{Binding NewPoint.LogMessage}" ToolTip="{}{Value}占位符"/>
                                </StackPanel>
                                <StackPanel Margin="5,0,0,0" Width="80">
                                    <TextBlock Text="分组" Foreground="#888" FontSize="10"/>
                                    <TextBox Text="{Binding NewPoint.Category}" ToolTip="用于过滤"/>
                                </StackPanel>
                                <StackPanel Margin="5,0,0,0" Width="40" Visibility="{Binding NewPoint.DataType, Converter={StaticResource DataTypeToVis}, ConverterParameter=Analog}">
                                    <TextBlock Text="阈值" Foreground="#888" FontSize="10"/>
                                    <TextBox Text="{Binding NewPoint.LogDeadband}" ToolTip="记录死区"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>

                <!-- Col 5: 添加/保存按钮 -->
                    <StackPanel Grid.Column="5" Orientation="Horizontal" VerticalAlignment="Center" Margin="5,0,0,0">
                        <Button Content="{Binding ActionName}" Width="50" Height="40" 
                                Style="{StaticResource ActionButton}" Command="{Binding AddPointCommand}"/>
                        
                        <Button Content="取消" Width="50" Height="40" Margin="5,0,0,0" Background="#333" BorderBrush="#555"
                                Command="{Binding CancelEditCommand}">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource ActionButton}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsEditing}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>

                </Grid>
            </Grid>
        </Border>

            <!-- 3. 底部：数据列表 -->
        <DataGrid Grid.Row="2" ItemsSource="{Binding Points}" SelectedItem="{Binding SelectedPoint}" 
                  AutoGenerateColumns="False" CanUserAddRows="False" 
                  CanUserSortColumns="False" IsReadOnly="True"
                  BorderThickness="1" Background="#0Affffff" HeadersVisibility="Column">
            <!-- 双击进入编辑模式 -->
            <DataGrid.InputBindings>
                <MouseBinding Gesture="LeftDoubleClick" Command="{Binding StartEditCommand}"/>
            </DataGrid.InputBindings>
            <DataGrid.Columns>
                <DataGridTextColumn Header="序号" Binding="{Binding RowIndex}" IsReadOnly="True" Width="Auto" MinWidth="40"/>
                <DataGridTextColumn Header="地址" Binding="{Binding Address}" Width="Auto" MinWidth="60"/>
                <DataGridTextColumn Header="位" Binding="{Binding BitIndex}" Width="Auto" MinWidth="30"/>
                <DataGridTextColumn Header="类型" Binding="{Binding DataType}" Width="Auto" MinWidth="50"/>

                <!-- 逻辑关联信息 -->
                <DataGridTextColumn Header="逻辑键 (Key)" Binding="{Binding UiBinding}" Width="Auto" MinWidth="100"/>
                <DataGridTextColumn Header="角色 (Role)" Binding="{Binding BindingRole}" Width="Auto" MinWidth="60"/>
                
                <!-- 动态/高级列 -->
                <DataGridTextColumn Header="高限" Binding="{Binding HighLimit}" Width="Auto" MinWidth="50"/>
                <DataGridTextColumn Header="低限" Binding="{Binding LowLimit}" Width="Auto" MinWidth="50"/>
                <DataGridTextColumn Header="State0" Binding="{Binding State0Desc}" Width="Auto" MinWidth="60"/>
                <DataGridTextColumn Header="State1" Binding="{Binding State1Desc}" Width="Auto" MinWidth="60"/>
                <DataGridTextColumn Header="报警值" Binding="{Binding AlarmTargetValue}" Width="Auto" MinWidth="50"/>
                
                <!-- 绑定 Names -->
                <DataGridTextColumn Header="Obj" Binding="{Binding TargetObjName}" Width="Auto" MinWidth="80"/>
                <DataGridTextColumn Header="Cfg" Binding="{Binding TargetBitConfigName}" Width="Auto" MinWidth="80"/>
                
                <!-- 同步 Names -->
                <DataGridCheckBoxColumn Header="Sync" Binding="{Binding IsSyncEnabled}" Width="Auto" MinWidth="40"/>
                <DataGridTextColumn Header="SyncDev" Binding="{Binding SyncTargetDeviceName}" Width="Auto" MinWidth="80"/>
                <DataGridTextColumn Header="SyncAddr" Binding="{Binding SyncTargetAddress}" Width="Auto" MinWidth="60"/>
                <DataGridTextColumn Header="SyncBit" Binding="{Binding SyncTargetBitIndex}" Width="Auto" MinWidth="50"/>
                <DataGridTextColumn Header="SyncMode" Binding="{Binding SyncMode}" Width="Auto" MinWidth="40"/>
                
                <!-- 日志 -->
                <DataGridCheckBoxColumn Header="Log" Binding="{Binding IsLogEnabled}" Width="Auto" MinWidth="40"/>
                <DataGridTextColumn Header="LogMsg" Binding="{Binding LogMessage}" Width="Auto" MinWidth="100"/>
                <DataGridTextColumn Header="类型" Binding="{Binding Category}" Width="Auto" MinWidth="60"/>
                
                <DataGridTextColumn Header="备注" Binding="{Binding Description}" Width="*"/>
            </DataGrid.Columns>
        </DataGrid>

    </Grid>
</UserControl>
