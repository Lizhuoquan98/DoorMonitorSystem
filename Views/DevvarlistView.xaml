<UserControl x:Class="DoorMonitorSystem.Views.DevvarlistView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:DoorMonitorSystem.Views"
             xmlns:vm="clr-namespace:DoorMonitorSystem.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1000">
    
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </UserControl.Resources>

    <UserControl.DataContext>
        <vm:DevvarlistViewModel/>
    </UserControl.DataContext>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 顶部：设备选择 -->
        <Border Grid.Row="0" Margin="0,0,0,15" Padding="15" BorderBrush="#33FFFFFF" BorderThickness="1" Background="#11FFFFFF" CornerRadius="5">
            <DockPanel>
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                    <TextBlock Text="选择设备：" VerticalAlignment="Center" FontSize="16" FontWeight="Bold" Foreground="White" Margin="0,0,10,0"/>
                    <ComboBox Width="250" ItemsSource="{Binding Devices}" SelectedItem="{Binding SelectedDevice}" DisplayMemberPath="Name"/>
                </StackPanel>
                
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" HorizontalAlignment="Right">
                    <Button Content="删除选中点位" Style="{StaticResource ActionButton}" Command="{Binding DeletePointCommand}"/>
                    <Button Content="保存修改" Style="{StaticResource ActionButton}" Command="{Binding SaveChangesCommand}" Background="#2200AA00" BorderBrush="#4400FF00"/>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- 中部：添加新点位 (表单) -->
        <Border Grid.Row="1" Margin="0,0,0,15" Padding="15" BorderBrush="#33FFFFFF" BorderThickness="1" Background="#11FFFFFF" CornerRadius="5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <StackPanel Margin="0,0,15,10">
                        <TextBlock Text="地址 (Address)" Foreground="#AAAAAA" FontSize="12" Margin="0,0,0,3"/>
                        <TextBox Width="120" Text="{Binding NewPoint.Address}" ToolTip="例如: 40001 或 DB1.10"/>
                    </StackPanel>

                    <StackPanel Margin="0,0,15,10">
                        <TextBlock Text="位索引 (Bit)" Foreground="#AAAAAA" FontSize="12" Margin="0,0,0,3"/>
                        <TextBox Width="60" Text="{Binding NewPoint.BitIndex}" ToolTip="0-15"/>
                    </StackPanel>

                    <StackPanel Margin="0,0,15,10">
                        <TextBlock Text="数据类型 (Type)" Foreground="#AAAAAA" FontSize="12" Margin="0,0,0,3"/>
                        <ComboBox Width="100" Text="{Binding NewPoint.DataType}" IsEditable="True">
                            <ComboBoxItem Content="Bit"/>
                            <ComboBoxItem Content="Bool"/>
                            <ComboBoxItem Content="Byte"/>
                            <ComboBoxItem Content="Word"/>
                            <ComboBoxItem Content="UInt16"/>
                            <ComboBoxItem Content="Int16"/>
                            <ComboBoxItem Content="Short"/>
                            <ComboBoxItem Content="DWord"/>
                            <ComboBoxItem Content="UInt32"/>
                            <ComboBoxItem Content="Int32"/>
                            <ComboBoxItem Content="Integer"/>
                            <ComboBoxItem Content="Float"/>
                            <ComboBoxItem Content="Real"/>
                        </ComboBox>
                    </StackPanel>

                    <StackPanel Margin="0,0,15,10">
                        <TextBlock Text="目标关联 (Association)" Foreground="#AAAAAA" FontSize="12" Margin="0,0,0,3"/>
                        <ToggleButton x:Name="BtnSelectPoint" Content="选择关联点位..." Width="120" Height="25" Background="#22FFFFFF" Foreground="White" BorderBrush="#44FFFFFF" Command="{Binding LoadTreeCommand}"/>
                        <Popup IsOpen="{Binding IsChecked, ElementName=BtnSelectPoint}" StaysOpen="False" PlacementTarget="{Binding ElementName=BtnSelectPoint}">
                           <Border Background="#1e1e1e" BorderBrush="#555" BorderThickness="1" MaxHeight="300" Width="250" Padding="5">
                               <TreeView ItemsSource="{Binding SelectorTree}" Background="Transparent" BorderThickness="0">
                                   <TreeView.ItemTemplate>
                                       <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                           <StackPanel Orientation="Horizontal">
                                                <!-- Icon placeholders could go here -->
                                               <TextBlock Text="{Binding Name}" Foreground="White" Margin="2">
                                                   <TextBlock.InputBindings>
                                                       <MouseBinding Gesture="LeftDoubleClick" Command="{Binding DataContext.SelectNodeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" CommandParameter="{Binding}"/>
                                                   </TextBlock.InputBindings>
                                               </TextBlock>
                                           </StackPanel>
                                       </HierarchicalDataTemplate> 
                                   </TreeView.ItemTemplate>
                                   <TreeView.ItemContainerStyle>
                                       <Style TargetType="TreeViewItem">
                                           <Setter Property="IsExpanded" Value="False"/>
                                           <Setter Property="Foreground" Value="White"/>
                                       </Style>
                                   </TreeView.ItemContainerStyle>
                               </TreeView>
                           </Border>
                        </Popup>
                    </StackPanel>
                    
                    <StackPanel Margin="0,0,15,10">
                         <TextBlock Text="已选目标" Foreground="#AAAAAA" FontSize="12" Margin="0,0,0,3"/>
                         <StackPanel Orientation="Horizontal">
                             <TextBlock Text="Type:" Foreground="Gray" Margin="0,0,5,0"/>
                             <TextBlock Text="{Binding NewPoint.TargetType}" Foreground="White" Margin="0,0,10,0" FontWeight="Bold"/>
                             <TextBlock Text="Obj:" Foreground="Gray" Margin="0,0,5,0"/>
                             <TextBlock Text="{Binding NewPoint.TargetObjId}" Foreground="White" Margin="0,0,10,0" FontWeight="Bold"/>
                             <TextBlock Text="Cfg:" Foreground="Gray" Margin="0,0,5,0"/>
                             <TextBlock Text="{Binding NewPoint.TargetBitConfigId}" Foreground="White" FontWeight="Bold"/>
                         </StackPanel>
                    </StackPanel>

                    <!-- 同步配置 -->
                    <Border Margin="0,0,15,10" BorderBrush="#33FFFFFF" BorderThickness="1" CornerRadius="3" Padding="5" Background="#05FFFFFF">
                        <StackPanel Orientation="Horizontal">
                            <CheckBox Content="开启同步" IsChecked="{Binding NewPoint.IsSyncEnabled}" VerticalAlignment="Center" Foreground="White" Margin="0,0,10,0"/>
                            
                            <StackPanel Margin="0,0,10,0" IsEnabled="{Binding NewPoint.IsSyncEnabled}">
                                <TextBlock Text="目标设备" Foreground="#AAAAAA" FontSize="10" Margin="0,0,0,2"/>
                                <!-- 这里的 ItemsSource 此时绑定的是 VM 的 Devices -->
                                <ComboBox Width="120" ItemsSource="{Binding Devices}" SelectedValue="{Binding NewPoint.SyncTargetDeviceId}" SelectedValuePath="ID" DisplayMemberPath="Name"/>
                            </StackPanel>

                            <StackPanel Margin="0,0,10,0" IsEnabled="{Binding NewPoint.IsSyncEnabled}">
                                <TextBlock Text="同步地址.位(Addr.Bit)" Foreground="#AAAAAA" FontSize="10" Margin="0,0,0,2"/>
                                <StackPanel Orientation="Horizontal">
                                    <TextBox Width="60" Text="{Binding NewPoint.SyncTargetAddress}"/>
                                    <TextBlock Text="." VerticalAlignment="Bottom" Margin="2,0,2,2" Foreground="White"/>
                                    <TextBox Width="30" Text="{Binding NewPoint.SyncTargetBitIndex}" ToolTip="目标位索引 (0-15)"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>
                    </Border>


                    <!-- 日志配置 -->
                    <Border Background="#33000000" BorderBrush="#33FFFFFF" BorderThickness="1" CornerRadius="3" Padding="5" Margin="0,0,10,10">
                        <StackPanel Orientation="Horizontal">
                            <StackPanel Margin="0,0,10,0">
                                <TextBlock Text="日志(Log)" Foreground="#AAAAAA" FontSize="12" Margin="0,0,0,3"/>
                                <CheckBox IsChecked="{Binding NewPoint.IsLogEnabled}" Content="启用" Foreground="White" Margin="0,3,0,0"/>
                            </StackPanel>
                            
                            <StackPanel Margin="0,0,10,0" Visibility="{Binding NewPoint.IsLogEnabled, Converter={StaticResource BoolToVis}}">
                                <TextBlock Text="类型(Type)" Foreground="#AAAAAA" FontSize="12" Margin="0,0,0,3"/>
                                <ComboBox Width="80" SelectedIndex="{Binding NewPoint.LogTypeId}">
                                    <ComboBoxItem Content="一般记录" Tag="1"/>
                                    <ComboBoxItem Content="报警记录" Tag="2"/>
                                </ComboBox>
                            </StackPanel>

                             <StackPanel Margin="0,0,10,0" Visibility="{Binding NewPoint.IsLogEnabled, Converter={StaticResource BoolToVis}}">
                                <TextBlock Text="触发(Trigger)" Foreground="#AAAAAA" FontSize="12" Margin="0,0,0,3"/>
                                <ComboBox Width="80" SelectedIndex="{Binding NewPoint.LogTriggerState}">
                                    <ComboBoxItem Content="False触发" Tag="0"/>
                                    <ComboBoxItem Content="True触发" Tag="1"/>
                                    <ComboBoxItem Content="双向触发" Tag="2"/>
                                </ComboBox>
                            </StackPanel>

                            <StackPanel Margin="0,0,10,0" Visibility="{Binding NewPoint.IsLogEnabled, Converter={StaticResource BoolToVis}}">
                                <TextBlock Text="自定义消息(Message)" Foreground="#AAAAAA" FontSize="12" Margin="0,0,0,3"/>
                                <TextBox Width="150" Text="{Binding NewPoint.LogMessage}" ToolTip="留空使用描述，支持 {Value} 替换"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <StackPanel Margin="0,0,15,10" Width="200">
                        <TextBlock Text="备注/日志内容 (Remark/Msg)" Foreground="#AAAAAA" FontSize="12" Margin="0,0,0,3"/>
                        <TextBox Text="{Binding NewPoint.Description}"/>
                    </StackPanel>
                </WrapPanel>

                <Button Grid.Column="1" Content="添加点位" Height="30" Padding="20,0" Style="{StaticResource ActionButton}" 
                        Command="{Binding AddPointCommand}" VerticalAlignment="Center" Margin="10,0,0,10"/>
            </Grid>
        </Border>

        <!-- 底部：点位列表 -->
        <DataGrid Grid.Row="2" ItemsSource="{Binding Points}" SelectedItem="{Binding SelectedPoint}" 
                  AutoGenerateColumns="False" CanUserAddRows="False" BorderThickness="1,1,1,1">
            <DataGrid.Columns>
                <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True" Width="50"/>
                <DataGridTextColumn Header="地址" Binding="{Binding Address}" Width="120"/>
                <DataGridTextColumn Header="类型" Binding="{Binding DataType}" Width="80"/>
                <DataGridTextColumn Header="Bit" Binding="{Binding BitIndex}" Width="50"/>
                
                <DataGridTextColumn Header="目标" Binding="{Binding TargetType}" Width="80"/>
                <DataGridTextColumn Header="Obj ID" Binding="{Binding TargetObjId}" Width="70"/>
                <DataGridTextColumn Header="Config ID" Binding="{Binding TargetBitConfigId}" Width="80"/>
                
                <DataGridCheckBoxColumn Header="同步?" Binding="{Binding IsSyncEnabled}" Width="60"/>
                <DataGridTextColumn Header="同步目标Dev" Binding="{Binding SyncTargetDeviceId}" Width="100"/>
                <DataGridTextColumn Header="同步目标Addr" Binding="{Binding SyncTargetAddress}" Width="100"/>
                
                <DataGridTextColumn Header="备注" Binding="{Binding Description}" Width="*"/>
            </DataGrid.Columns>
        </DataGrid>
    </Grid>
</UserControl>
