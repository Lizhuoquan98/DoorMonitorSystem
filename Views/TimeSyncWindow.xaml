<Window x:Class="DoorMonitorSystem.Views.TimeSyncWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:DoorMonitorSystem.Views"
         Width="650" Height="730"
        Title="设备校时配置"
        WindowStartupLocation="CenterScreen"
        Background="#161b22">

    <Window.Resources>
        <!-- Modern TextBox -->
        <Style TargetType="TextBox">
            <Setter Property="Padding" Value="5"/>
            <Setter Property="Background" Value="#1a1f2e"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#2a5f8f"/>
            <Setter Property="CaretBrush" Value="White"/>
        </Style>
        
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <!-- Modern TextBlock -->
        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="#e6edf3"/>
        </Style>
        <!-- Modern CheckBox -->
        <Style TargetType="CheckBox">
            <Setter Property="Foreground" Value="#e6edf3"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
         <!-- Modern RadioButton -->
        <Style TargetType="RadioButton">
            <Setter Property="Foreground" Value="#e6edf3"/>
            <Setter Property="Margin" Value="0,0,10,0"/>
             <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
         <!-- Modern GroupBox -->
        <Style TargetType="GroupBox">
            <Setter Property="Foreground" Value="#2196F3"/>
            <Setter Property="BorderBrush" Value="#2a5f8f"/>
            <Setter Property="Margin" Value="0,0,0,10"/>
        </Style>
        
        <Style TargetType="Button">
            <Setter Property="Background" Value="#2196F3"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="15,6"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                         <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#1976D2"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock Text="⏰ 设备校时配置" FontSize="20" FontWeight="Bold" Foreground="#2196F3"/>
            <TextBlock Text="配置上位机(PC)与PLC之间的时间同步策略" FontSize="12" Foreground="#8b949e" Margin="0,5,0,0"/>
        </StackPanel>

        <!-- Content -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                
                <!-- 1. 功能开关 -->
                <GroupBox Header="基础设置">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                           <RowDefinition Height="10"/>
                           <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <CheckBox Grid.Row="0" Grid.Column="0" Content="启用校时功能" IsChecked="{Binding Config.Enabled}" FontWeight="Bold" FontSize="14"/>
                        
                        <StackPanel Grid.Row="0" Grid.Column="2" Orientation="Horizontal">
                           <TextBlock Text="方向:  " VerticalAlignment="Center"/>
                           <ComboBox SelectedIndex="{Binding Direction}" Width="150" Padding="5">
                               <ComboBoxItem Content="PC -> PLC (下发)"/>
                               <ComboBoxItem Content="PLC -> PC (受时)"/>
                           </ComboBox>
                        </StackPanel>
                    </Grid>
                </GroupBox>

                <!-- 2. 调度策略 -->
                <GroupBox Header="调度策略 (Schedule)" Visibility="{Binding IsDownstream, Converter={StaticResource BooleanToVisibilityConverter}}">
                     <Grid Margin="10">
                         <Grid.RowDefinitions>
                             <RowDefinition Height="Auto"/>
                             <RowDefinition Height="10"/>
                             <RowDefinition Height="Auto"/>
                         </Grid.RowDefinitions>
                         
                         <!-- 模式选择 -->
                         <StackPanel Orientation="Horizontal" Grid.Row="0">
                             <RadioButton Content="周期模式 (Interval)" IsChecked="{Binding IsIntervalMode}"/>
                             <RadioButton Content="定点模式 (Fixed Time)" IsChecked="{Binding IsFixedTimeMode}"/>
                         </StackPanel>

                         <!-- 参数 -->
                         <StackPanel Orientation="Horizontal" Grid.Row="2">
                             <TextBlock Text="周期(秒): " VerticalAlignment="Center" Visibility="{Binding IsIntervalMode, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                             <TextBox Width="80" Text="{Binding Config.IntervalSeconds}" IsEnabled="{Binding IsIntervalMode}" Margin="0,0,20,0"/>
                             
                             <TextBlock Text="每天执行时间(HH:mm:ss): " VerticalAlignment="Center"/>
                             <TextBox Width="100" Text="{Binding Config.FixedTime}" IsEnabled="{Binding IsFixedTimeMode}"/>
                             
                             <TextBlock Text="  重试次数: " VerticalAlignment="Center" Margin="20,0,0,0"/>
                             <TextBox Width="50" Text="{Binding Config.RetryCount}"/>
                         </StackPanel>
                     </Grid>
                </GroupBox>

                <!-- 3. 高级 RTU 策略 -->
                <GroupBox Header="多机通讯策略 (Advanced RTU)" Visibility="{Binding IsDownstream, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="10"/>
                            <RowDefinition Height="Auto"/>
                             <RowDefinition Height="10"/>
                             <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                         <StackPanel Orientation="Horizontal" Grid.Row="0">
                             <RadioButton Content="单机模式 (Self)" IsChecked="{Binding IsStrategySelf}" ToolTip="仅针对当前配置的SlaveID发送"/>
                             <RadioButton Content="广播模式 (Broadcast)" IsChecked="{Binding IsStrategyBroadcast}" ToolTip="向指定站号(如255)发送广播包"/>
                             <RadioButton Content="轮询范围 (Range Poll)" IsChecked="{Binding IsStrategyRange}" ToolTip="自动遍历指定范围的站号(如1-10)"/>
                         </StackPanel>

                        <StackPanel Orientation="Horizontal" Grid.Row="2">
                            <TextBlock Text="广播站号:" VerticalAlignment="Center" Width="70"/>
                            <TextBox Width="60" Text="{Binding Config.BroadcastStationId}" IsEnabled="{Binding IsStrategyBroadcast}"/>
                            <TextBlock Text="  (通常为 255/0, 不回复)" Foreground="Gray" VerticalAlignment="Center" FontSize="10"/>
                            
                            <TextBlock Text="站号范围:" VerticalAlignment="Center" Margin="30,0,0,0" Width="70"/>
                            <TextBox Width="150" Text="{Binding Config.SlaveIdRange}" IsEnabled="{Binding IsStrategyRange}"/>
                            <TextBlock Text="  (格式: 1-10; 20,25)" Foreground="Gray" VerticalAlignment="Center" FontSize="10"/>
                        </StackPanel>
                        
                        <StackPanel Orientation="Horizontal" Grid.Row="4">
                             <CheckBox Content="强制逐字写入 (Force FC06)" IsChecked="{Binding Config.ForceSingleWrite}" ToolTip="勾选后，将使用FC06功能码逐个寄存器写入，兼容老旧设备"/>
                             
                             <TextBlock Text="  补偿(ms):" VerticalAlignment="Center" Margin="20,0,0,0"/>
                             <TextBox Width="50" Text="{Binding Config.OffsetMs}" ToolTip="仅受时模式有效: 补偿网络/轮询延迟。例如设为 250"/>
                        </StackPanel>
                    </Grid>
                </GroupBox>

                <!-- 4. 地址映射 -->
                <GroupBox Header="寄存器地址映射 (Address Mapping)">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="20"/>
                            <ColumnDefinition Width="Auto"/>
                             <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="5"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="5"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Text="年 (Year):" Grid.Row="0" Grid.Column="0" VerticalAlignment="Center"/>
                        <TextBox Text="{Binding Config.AddressYear}" Grid.Row="0" Grid.Column="1"/>
                        
                        <TextBlock Text="月 (Month):" Grid.Row="0" Grid.Column="3" VerticalAlignment="Center"/>
                        <TextBox Text="{Binding Config.AddressMonth}" Grid.Row="0" Grid.Column="4"/>
                        
                        <TextBlock Text="日 (Day):" Grid.Row="2" Grid.Column="0" VerticalAlignment="Center"/>
                        <TextBox Text="{Binding Config.AddressDay}" Grid.Row="2" Grid.Column="1"/>

                        <TextBlock Text="时 (Hour):" Grid.Row="2" Grid.Column="3" VerticalAlignment="Center"/>
                        <TextBox Text="{Binding Config.AddressHour}" Grid.Row="2" Grid.Column="4"/>

                        <TextBlock Text="分 (Minute):" Grid.Row="4" Grid.Column="0" VerticalAlignment="Center"/>
                        <TextBox Text="{Binding Config.AddressMinute}" Grid.Row="4" Grid.Column="1"/>
                        
                        <TextBlock Text="秒 (Second):" Grid.Row="4" Grid.Column="3" VerticalAlignment="Center"/>
                        <StackPanel Grid.Row="4" Grid.Column="4" Orientation="Horizontal">
                            <TextBox Text="{Binding Config.AddressSecond}" Width="100"/>
                            <TextBlock Text="格式:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                             <ComboBox SelectedIndex="{Binding Config.SecondFormat}" Width="60">
                               <ComboBoxItem Content="秒"/>
                               <ComboBoxItem Content="毫秒"/>
                           </ComboBox>
                        </StackPanel>

                    </Grid>
                </GroupBox>
                
                <!-- 5. 触发/握手 -->
                <GroupBox Header="握手信号 (Handshake)">
                    <Grid Margin="10">
                         <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Text="触发地址:" Grid.Column="0" VerticalAlignment="Center"/>
                        <TextBox Text="{Binding Config.TriggerAddress}" Grid.Column="1" Margin="10,0" Width="100" HorizontalAlignment="Left"/>
                        
                        <TextBlock Text="写入值:" Grid.Column="2" VerticalAlignment="Center" Margin="10,0,0,0"/>
                        <TextBox Text="{Binding Config.TriggerValue}" Grid.Column="3" Margin="10,0" Width="50" HorizontalAlignment="Left"/>
                        
                        <CheckBox Grid.Column="3" Content="脉冲复位 (Pulse)" IsChecked="{Binding Config.IsTriggerPulse}" HorizontalAlignment="Right" ToolTip="写入后500ms自动复位为0"
                                  Visibility="{Binding IsDownstream, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </Grid>
                </GroupBox>

            </StackPanel>
        </ScrollViewer>

        <!-- Buttons -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5,0,0" Height="30">
            <Button Content="确认保存" Command="{Binding SaveCommand}" Width="100" Margin="0,0,10,0"/>
            <Button Content="关闭" Command="{Binding CloseCommand}" Width="80" Background="#424242"/>
        </StackPanel>
    </Grid>
</Window>
